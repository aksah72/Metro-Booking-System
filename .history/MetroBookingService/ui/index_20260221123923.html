<!DOCTYPE html>
<html>
<head>
    <title>Metro Booking System</title>

    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body class="bg-light">

<div class="container mt-5">

    <h1 class="text-center mb-4">ðŸš‡ Metro Booking System</h1>

    <!-- Login Card -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <h4>Login</h4>

            <div class="row">
                <div class="col-md-4">
                    <input type="text" id="username" class="form-control" value="admin">
                </div>
                <div class="col-md-4">
                    <input type="password" id="password" class="form-control" value="admin">
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" onclick="login()">Login</button>
                </div>
            </div>

            <div class="mt-3">
                <strong>Token:</strong>
                <span id="tokenDisplay" class="text-success"></span>
            </div>
        </div>
    </div>

    <!-- Booking Card -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <h4>Create Booking</h4>

            <div class="row">
                <div class="col-md-5">
                    <input type="text" id="source" class="form-control" placeholder="Source (A)">
                </div>
                <div class="col-md-5">
                    <input type="text" id="destination" class="form-control" placeholder="Destination (E)">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success w-100" onclick="createBooking()">Book</button>
                </div>
            </div>

            <div id="bookingAlert" class="mt-3"></div>

            <pre id="bookingResult" class="bg-light p-3 mt-3"></pre>
            <div class="mt-3">
                <h5>QR Code</h5>
                <div id="qrContainer"></div>
            </div>
        </div>
    </div>

    <!-- Stops and Routes -->
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-body">
                    <h5>Stops</h5>
                    <button class="btn btn-outline-primary mb-2" onclick="getStops()">Load Stops</button>
                    <pre id="stopsResult"></pre>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-body">
                    <h5>Routes</h5>
                    <button class="btn btn-outline-primary mb-2" onclick="getRoutes()">Load Routes</button>
                    <pre id="routesResult"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking History -->
<div class="card shadow mb-4">
    <div class="card-body">
        <h4>My Bookings</h4>
        <button class="btn btn-warning mb-2" onclick="getBookings()">Load My Bookings</button>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Source</th>
                    <th>Destination</th>
                    <th>Transfers</th>
                    <th>Fare</th>
                </tr>
            </thead>
            <tbody id="bookingTable"></tbody>
        </table>
    </div>
</div>

</div>

<script>

let authToken = "";
function renderMetroMap(path) {

const map = document.getElementById("metroMap");
map.innerHTML = "";

path.forEach((station, index) => {

    const stop = document.createElement("div");

    stop.style.display = "inline-block";
    stop.style.marginRight = "40px";
    stop.style.textAlign = "center";

    stop.innerHTML = `
        <div style="
            width:20px;
            height:20px;
            background:#007bff;
            border-radius:50%;
            margin:auto;
        "></div>
        <small>${station}</small>
    `;

    map.appendChild(stop);

    if (index !== path.length - 1) {
        const line = document.createElement("span");
        line.style.display = "inline-block";
        line.style.width = "40px";
        line.style.height = "4px";
        line.style.background = "#007bff";
        line.style.verticalAlign = "middle";
        map.appendChild(line);
    }
});
}

async function login() {

    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;

    const response = await fetch("http://localhost:8080/login", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ username, password })
    });

    const data = await response.json();

    if (data.token) {
        authToken = data.token;
        document.getElementById("tokenDisplay").innerText = authToken;
    } else {
        alert("Login Failed");
    }
}

async function createBooking() {

const source = document.getElementById("source").value;
const destination = document.getElementById("destination").value;

const response = await fetch("http://localhost:8080/booking", {
    method: "POST",
    headers: {
        "Content-Type": "application/json",
        "Authorization": authToken
    },
    body: JSON.stringify({ source, destination })
});

const data = await response.json();

const alertBox = document.getElementById("bookingAlert");
const qrDiv = document.getElementById("qrContainer");

qrDiv.innerHTML = "";

if (data.error) {
    alertBox.innerHTML =
        `<div class="alert alert-danger">${data.error}</div>`;
    return;
}

alertBox.innerHTML =
    `<div class="alert alert-success">
        Booking Successful! ID: ${data.bookingId}
    </div>`;

document.getElementById("bookingResult").innerText =
    JSON.stringify(data, null, 2);

// Generate QR
new QRCode(qrDiv, {
    text: data.qr,
    width: 150,
    height: 150
});
}

async function getStops() {
    const response = await fetch("http://localhost:8080/stops");
    const data = await response.json();
    document.getElementById("stopsResult").innerText =
        JSON.stringify(data, null, 2);
}

async function getRoutes() {
    const response = await fetch("http://localhost:8080/routes");
    const data = await response.json();
    document.getElementById("routesResult").innerText =
        JSON.stringify(data, null, 2);
}
async function getBookings() {

const response = await fetch("http://localhost:8080/bookings", {
    headers: {
        "Authorization": authToken
    }
});

const data = await response.json();

const table = document.getElementById("bookingTable");
table.innerHTML = "";

if (data.error) {
    alert(data.error);
    return;
}

data.forEach(b => {
    const row = `
        <tr>
            <td>${b.bookingId}</td>
            <td>${b.source}</td>
            <td>${b.destination}</td>
            <td>${b.transfers}</td>
            <td>â‚¹ ${b.fare}</td>
        </tr>
    `;
    table.innerHTML += row;
});
}

</script>

</body>
</html>
