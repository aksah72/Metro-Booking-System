<!DOCTYPE html>
<html>
<head>
    <title>Metro Booking System</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body { background: #f4f6f9; }

        .card { border-radius: 15px; }

        .station {
            display:inline-block;
            text-align:center;
            margin:0 25px;
        }

        .circle {
            width:25px;
            height:25px;
            border-radius:50%;
            margin:auto;
        }

        .line {
            display:inline-block;
            width:40px;
            height:4px;
            background:#999;
            vertical-align:middle;
        }

        .source { background:#28a745; }
        .destination { background:#dc3545; }
        .interchange { background:#ff9800; }
        .normal { background:#007bff; }

        #dashboard { display:none; }
    </style>
</head>

<body>

<div class="container mt-5">

    <h1 class="text-center mb-4">ðŸš‡ Metro Booking System</h1>

    <!-- ================= AUTH SECTION ================= -->
    <div id="authSection" class="card shadow p-4">

        <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
                <button class="nav-link active" onclick="switchTab('login')">Sign In</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="switchTab('register')">Sign Up</button>
            </li>
        </ul>

        <div id="loginBox">
            <input type="text" id="loginUser" class="form-control mb-2" placeholder="Username">
            <input type="password" id="loginPass" class="form-control mb-2" placeholder="Password">
            <button class="btn btn-primary w-100" onclick="login()">Sign In</button>
        </div>

        <div id="registerBox" style="display:none;">
            <input type="text" id="regUser" class="form-control mb-2" placeholder="Username">
            <input type="password" id="regPass" class="form-control mb-2" placeholder="Password">
            <button class="btn btn-success w-100" onclick="register()">Sign Up</button>
        </div>

        <div class="mt-3 text-success" id="authMessage"></div>
    </div>

    <!-- ================= DASHBOARD ================= -->
    <div id="dashboard">

        <!-- BOOKING CARD -->
        <div class="card shadow mt-4 p-4">
            <h4>Book Ticket</h4>

            <div class="row">
                <div class="col-md-5">
                    <input type="text" id="source" class="form-control" placeholder="Source">
                </div>
                <div class="col-md-5">
                    <input type="text" id="destination" class="form-control" placeholder="Destination">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success w-100" onclick="createBooking()">Book</button>
                </div>
            </div>

            <div id="bookingInfo" class="mt-4"></div>

            <div class="mt-4">
                <h5>Metro Route Map</h5>
                <div id="metroMap" class="p-3 bg-light rounded"></div>
            </div>

            <div class="mt-4">
                <h5>QR Code</h5>
                <div id="qrContainer"></div>
            </div>
        </div>

    </div>

</div>

<script>

let authToken = "";

/* ================= TAB SWITCH ================= */
function switchTab(type) {

    document.getElementById("loginBox").style.display =
        type === "login" ? "block" : "none";

    document.getElementById("registerBox").style.display =
        type === "register" ? "block" : "none";
}

/* ================= REGISTER ================= */
async function register() {

    const username = regUser.value;
    const password = regPass.value;

    const res = await fetch("http://localhost:8080/register", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({username,password})
    });

    const data = await res.json();
    document.getElementById("authMessage").innerText =
        data.message || data.error;
}

/* ================= LOGIN ================= */
async function login() {

    const username = loginUser.value;
    const password = loginPass.value;

    const res = await fetch("http://localhost:8080/login", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({username,password})
    });

    const data = await res.json();

    if(data.token){
        authToken = data.token;
        document.getElementById("authSection").style.display="none";
        document.getElementById("dashboard").style.display="block";
    } else {
        document.getElementById("authMessage").innerText="Login Failed";
    }
}

/* ================= BOOKING ================= */
async function createBooking(){

    const res = await fetch("http://localhost:8080/booking",{
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "Authorization":authToken
        },
        body: JSON.stringify({
            source:source.value,
            destination:destination.value
        })
    });

    const data = await res.json();

    if(data.error){
        bookingInfo.innerHTML =
            `<div class="alert alert-danger">${data.error}</div>`;
        return;
    }

    bookingInfo.innerHTML = `
        <div class="alert alert-success">
            <strong>Booking ID:</strong> ${data.bookingId} <br>
            <strong>Fare:</strong> â‚¹ ${data.fare} <br>
            <strong>Transfers:</strong> ${data.transfers} <br>
            <strong>Total Stops:</strong> ${data.route.length}
        </div>
    `;

    renderMap(data.route, data.transfers);

    qrContainer.innerHTML="";
    new QRCode(qrContainer,{
        text:data.qr,
        width:150,
        height:150
    });
}

/* ================= MAP RENDER ================= */
function renderMap(path, transfers){

    metroMap.innerHTML="";

    path.forEach((station,index)=>{

        const div=document.createElement("div");
        div.className="station";

        let cls="normal";

        if(index===0) cls="source";
        else if(index===path.length-1) cls="destination";
        else if(transfers>0 && index===Math.floor(path.length/2))
            cls="interchange";

        div.innerHTML=`
            <div class="circle ${cls}"></div>
            <small>${station}</small>
        `;

        metroMap.appendChild(div);

        if(index!==path.length-1){
            const line=document.createElement("span");
            line.className="line";
            metroMap.appendChild(line);
        }
    });
}

</script>

</body>
</html>