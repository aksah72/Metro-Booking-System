<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Metro App</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<style>

/* =========================
   BACKGROUND ANIMATION
========================= */
body{
    margin:0;
    font-family:'Segoe UI',sans-serif;
    color:white;
    min-height:100vh;
    overflow-x:hidden;

    background:
        linear-gradient(rgba(0,0,0,0.65), rgba(0,0,0,0.65)),
        url("/ui/metro.jpg");

    background-size:cover;
    background-position:center;
    background-attachment:fixed;

    animation: zoomBackground 30s infinite alternate ease-in-out;
}

/* Smooth zoom animation */
@keyframes zoomBackground{
    from{ background-size:100%; }
    to{ background-size:110%; }
}

body::before{
    content:"";
    position:fixed;
    top:0;
    left:0;
    width:200%;
    height:100%;
    background:
        repeating-linear-gradient(
            90deg,
            rgba(255,255,255,0.05) 0px,
            rgba(255,255,255,0.05) 2px,
            transparent 2px,
            transparent 70px
        );
    animation: slide 25s linear infinite;
    z-index:-1;
}

@keyframes slide{
    from { background-position:0 0; }
    to { background-position:1000px 0; }
}

/* =========================
   LAYOUT
========================= */
.app-container{
    max-width:420px;
    margin:auto;
    padding-top:20px;
}

.app-header{
    font-size:24px;
    font-weight:600;
    text-align:center;
    margin-bottom:15px;
}

.card-box{
    background:white;
    color:black;
    border-radius:20px;
    padding:20px;
    margin-bottom:20px;
    box-shadow:0 10px 30px rgba(0,0,0,0.2);
}

/* =========================
   METRO ROUTE DISPLAY
========================= */
.metro-map{
    margin-top:15px;
    padding-left:40px;
    position:relative;
}

.station{
    position:relative;
    margin-bottom:20px;
    font-weight:500;
    cursor:pointer;
    transition: all 0.3s ease;
    opacity:0;
    animation: fadeIn 0.5s ease forwards;
}

.station:hover{
    transform: translateX(8px) scale(1.05);
    font-weight:600;
}

.station::before{
    content:"";
    position:absolute;
    left:-28px;
    top:4px;
    width:16px;
    height:16px;
    border-radius:50%;
    background:#007bff;
    transition: all 0.3s ease;
}

.station:hover::before{
    box-shadow:0 0 10px white, 0 0 20px white;
}

.line-R::before{ background:#e74c3c !important; }
.line-B::before{ background:#3498db !important; }
.line-Y::before{ background:#f1c40f !important; }

.line-R:hover::before{
    box-shadow:0 0 10px #e74c3c,0 0 20px #e74c3c;
}
.line-B:hover::before{
    box-shadow:0 0 10px #3498db,0 0 20px #3498db;
}
.line-Y:hover::before{
    box-shadow:0 0 10px #f1c40f,0 0 20px #f1c40f;
}

.interchange::before{
    animation:pulse 1.5s infinite;
    border:3px solid black;
}

.source::before{ background:#28a745 !important; }
.destination::before{ background:#dc3545 !important; }

@keyframes pulse{
    0%{ transform:scale(1); }
    50%{ transform:scale(1.3); }
    100%{ transform:scale(1); }
}

@keyframes fadeIn{
    from{ opacity:0; transform:translateX(-10px); }
    to{ opacity:1; transform:translateX(0); }
}

.booking-summary{
    background:#f8f9fa;
    padding:15px;
    border-radius:10px;
}

</style>
</head>

<body>

<div class="app-container">

<div class="app-header">ðŸš‡ Metro Booking</div>

<!-- LOGIN / REGISTER -->
<div id="authSection" class="card-box">
<h5>Login</h5>

<input type="email" id="email" class="form-control mb-2" placeholder="Email">
<input type="password" id="password" class="form-control mb-3" placeholder="Password">

<button class="btn btn-primary w-100 mb-2" onclick="login()">Login</button>
<button class="btn btn-outline-secondary w-100 mb-2" onclick="register()">Register</button>

<div id="authMessage" class="text-danger mt-2"></div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" style="display:none;">

<div class="card-box">
<h6>Book Ticket</h6>

<select id="bookingSource" class="form-select mb-2"></select>
<select id="bookingDestination" class="form-select mb-3"></select>

<button class="btn btn-success w-100" onclick="createBooking()">Find Route</button>
</div>

<div id="routeSection" class="card-box" style="display:none;">
<h6>Route Details</h6>
<div id="bookingSummary" class="booking-summary mb-3"></div>
<div id="metroMap" class="metro-map"></div>
<div id="qrContainer" style="margin-top:20px;text-align:center;"></div>
</div>

</div>
</div>

<script>

let authToken="";
let currentBookingId="";

/* ======================
   STATION LIST
====================== */
const stations = [
{ name:"North City", line:"R" },
{ name:"Tech Park", line:"R" },
{ name:"Central Market", line:"R" },
{ name:"City Hospital", line:"R" },
{ name:"Grand Junction", line:"R" },
{ name:"Museum", line:"R" },
{ name:"Old Town", line:"R" },
{ name:"South Terminal", line:"R" },

{ name:"Airport", line:"B" },
{ name:"IT Hub", line:"B" },
{ name:"Lake View", line:"B" },
{ name:"City Center", line:"B" },
{ name:"Stadium", line:"B" },
{ name:"University", line:"B" },
{ name:"West End", line:"B" },

{ name:"Industrial Area", line:"Y" },
{ name:"Science Park", line:"Y" },
{ name:"Metro Plaza", line:"Y" },
{ name:"Railway Station", line:"Y" },
{ name:"East Market", line:"Y" },
{ name:"Old Port", line:"Y" }
];

function loadStations(){
    const source=document.getElementById("bookingSource");
    const dest=document.getElementById("bookingDestination");

    source.innerHTML="<option disabled selected>Select Source</option>";
    dest.innerHTML="<option disabled selected>Select Destination</option>";

    stations.forEach(st=>{
        source.innerHTML+=`<option value="${st.name}">${st.name} (${st.line})</option>`;
        dest.innerHTML+=`<option value="${st.name}">${st.name} (${st.line})</option>`;
    });
}

/* ======================
   AUTH
====================== */
async function register(){
const res=await fetch("/register",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({email:email.value,password:password.value})});
const data=await res.json();
authMessage.innerText=data.error?data.error:"Registered successfully. Please login.";
}

async function login(){
const res=await fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({email:email.value,password:password.value})});
const data=await res.json();
if(data.token){
authToken=data.token;
authSection.style.display="none";
dashboard.style.display="block";
loadStations();
}else authMessage.innerText="Invalid login";
}

/* ======================
   BOOKING
====================== */
async function createBooking(){
const res=await fetch("/booking",{method:"POST",
headers:{"Content-Type":"application/json","Authorization":authToken},
body:JSON.stringify({source:bookingSource.value,destination:bookingDestination.value})});
const data=await res.json();
if(data.error){alert(data.error);return;}
currentBookingId=data.bookingId;
routeSection.style.display="block";

bookingSummary.innerHTML=`
<strong>Fare:</strong> â‚¹ ${data.fare}<br>
<strong>Duration:</strong> ${data.duration} mins<br>
<strong>Transfers:</strong> ${data.transfers}
<br><br>
<button class="btn btn-primary w-100" onclick="makePayment()">Pay Now</button>
`;

renderRoute(data.segments);
}

/* ======================
   ROUTE RENDER
====================== */
function renderRoute(segments){
const metroMap=document.getElementById("metroMap");
metroMap.innerHTML="";
segments.forEach(seg=>{
seg.stops.forEach(st=>{
let div=document.createElement("div");
div.className="station line-"+seg.line;
div.innerText=st;
metroMap.appendChild(div);
});
});
}

/* ======================
   PAYMENT
====================== */
async function makePayment(){
const res=await fetch("/pay",{method:"POST",
headers:{"Content-Type":"application/json","Authorization":authToken},
body:JSON.stringify({bookingId:parseInt(currentBookingId)})});
const data=await res.json();
if(data.error){alert(data.error);return;}
alert("Payment Successful âœ…");
const qrDiv=document.getElementById("qrContainer");
qrDiv.innerHTML="";
new QRCode(qrDiv,{text:data.qr,width:150,height:150});
}

</script>
</body>
</html>